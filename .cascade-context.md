# SR.AnalogGain – Assistant Context

This file gives AI assistants and new contributors the minimal project context needed to help effectively without re-discovering domain and project specifics each time.

## TL;DR
- VST3 audio plugin built with NPlug on .NET 9 (Windows focus).
- Plugin provides analog-style gain with gentle coloration and custom Win32 UI (two knobs: GAIN, OUTPUT).
- Build is AOT-published and can optionally auto-copy the .vst3 to the system VST3 folder.

## Stack and Key Packages
- .NET: `net9.0`
- VST3 managed binding: `NPlug` (NuGet)
- UI: Win32 (GDI+) custom windowing (no cross-platform UI)
- Imaging: `System.Drawing.Common`

## Plugin Architecture
- VST3 model separates Controller and Processor per Steinberg’s architecture.
- Factory exported via `AnalogGainPlugin.GetFactory()` and module initializer.

Files of interest (root directory):
- `AnalogGainProcessor.cs`
  - Class: `AnalogGainProcessor : AudioProcessor<AnalogGainModel>`
  - Audio I/O, per-sample processing, coloration filters, RMS-driven nonlinearity, output trim
  - References Controller via `ControllerClassId => AnalogGainController.ClassId`
- `AnalogGainController.cs`
  - Class: `AnalogGainController : AudioController<AnalogGainModel>`
  - Creates the editor view via `CreateView()`
- `AnalogGainEditor.cs`
  - Class: `AnalogGainEditor : IAudioPluginView`
  - Hosts `UI.Win32.FixedDualKnobWindow` (two knobs: Gain left, Output right)
  - DPI/content scaling aware; fixed preferred size with user multiplier
- `AnalogGainModel.cs`
  - Class: `AnalogGainModel : AudioProcessorModel`
  - Declares parameters and defaults
- `AnalogGainPlugin.cs`
  - Registers Processor and Controller into NPlug factory; module initializer exports the factory
- `SR.AnalogGain.csproj`
  - Adds embedded resources from `Assets/`
  - Package references, publish/copy-to VST3 folder toggle

## Parameters
Declared in `AnalogGainModel.cs` and used project-wide.
- Gain (`model.Gain`)
  - Range: -60 dB .. +12 dB
  - Default: 0 dB (normalized midpoint computed from dB mapping)
  - Mapping: normalized [0..1] → dB → linear
- Output (`model.Output`)
  - Range: -24 dB .. +12 dB
  - Default: 0 dB
  - Mapping: normalized [0..1] → dB → linear

UI wiring in `AnalogGainEditor.cs`:
- Left knob controls `Gain` with min/max dB of -60/+12
- Right knob controls `Output` with min/max dB of -24/+12

## DSP Highlights (Processor)
Inside `AnalogGainProcessor.ProcessMain`:
- Input gain smoothing and conversion from normalized → dB → linear
- RMS envelope detector drives a dynamic drive scalar for the shaper
- Asymmetric ADAA tanh shaper with small DC removal
- Mild pre/post shelves and subtle high-shelf/tilt; very gentle HF low-pass
- Output trim with smoothing

Implementation helpers in `AnalogGainProcessor.cs`:
- `RmsDetector`, `Biquad` (low/high shelf), `OnePoleLP`, `DcBlock`
- `Shaper.ProcessAsymTanhADAA` with slope normalization and soft limiting

## UI and Scaling
`AnalogGainEditor`:
- Preferred logical size: 1024x512 (before scaling)
- Host content scale × `UserUiScale` (0.50) with clamp [0.5, 4.0]
- Platform: `AudioPluginViewPlatform.Hwnd` only

## Assets and Resources
Embedded via `SR.AnalogGain.csproj` from `Assets/`:
- Background and knob bitmaps (e.g., `Bg1024x512.png`, `KnobFace512.png`, knob pointer sprites)

## Build and Install
From `README.md` and `.csproj`:
- Build (AOT):
  - `dotnet publish -c Release -r win-x64 -p:PublishAot=true`
- Output: `bin/Release/net9.0/win-x64/publish/`
- Optional post-publish copy to VST3 folder controlled by msbuild properties:
  - `CopyVST3OnPublish=true` (default in project)
  - Destination: `$(CommonProgramFiles)\VST3`
- Manual install path (Windows): `C:\Program Files\Common Files\VST3`

## Development Guidelines
- Keep parameter ranges consistent across `Model`, `Editor`, and `Processor` (avoid drift in min/max dB and defaults).
- When adding parameters:
  - Define in `AnalogGainModel`
  - Wire UI in `AnalogGainEditor` (begin/perform/end edit)
  - Map normalized → engineering units → linear in `AnalogGainProcessor`
- UI is Windows-only. On non-Windows hosts, expect fallback generic parameter view.
- Maintain smooth transitions for any time-varying parameter to avoid zipper noise.
 
## Parameter Add Checklist
1) Model (`AnalogGainModel.cs`)
   - Define a new `AudioParameter` with a clear name, `units`, and a suitable `defaultNormalizedValue`.
   - If using dB or other units, compute the default normalized value from the engineering default (e.g., 0 dB).
   - Expose a property for the parameter, e.g., `public AudioParameter Tone { get; }`.

2) Editor (`AnalogGainEditor.cs`)
   - Connect UI control callbacks to the new parameter:
     - `begin`: `_controller.BeginEditParameter(modelParam)`
     - `perform`: set `NormalizedValue` clamped to [0,1]
     - `end`: `_controller.EndEditParameter()`
   - If applicable, add hit-testing in `TryFindParameter` to map mouse regions to the new parameter.
   - Update labels, ranges (min/max), and any on-screen readouts.

3) Processor (`AnalogGainProcessor.cs`)
   - Read `Model.<Param>.NormalizedValue` and map normalized → engineering units (e.g., dB → linear) consistently with the UI labels.
   - Smooth any time-varying controls to avoid zipper noise.
   - Apply the parameter in the signal path at an appropriate point. Keep CPU budget in mind.

4) Consistency and Testing
   - Ensure min/max and default values match across Model, Editor, and Processor.
   - Verify automation gestures work (begin/perform/end).
   - Test at different sample rates and buffer sizes.
   - Check behavior at extreme values and transitions.

## Common Assistant Tasks
- Add a new parameter (e.g., Tone, Mix, Bias) end-to-end (Model, Editor, Processor)
- Adjust knob ranges or dB mapping
- Refine DSP filters or nonlinear curve while keeping CPU budget modest
- Improve DPI scaling or keyboard/mouse interaction in the editor
- Extend asset pipeline (additional sprites/skins)

## Contact/Attribution
- Vendor: Sonic Riot (see `AnalogGainPlugin.GetFactory()` for URL/email)
- License: MIT (see `LICENSE.txt`)

